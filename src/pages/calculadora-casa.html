<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Calculadora Casa - EcoTrack</title>
  <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
  <main class="container">
    <h1>Calculadora de Consumo da Casa</h1>
    <p>Você pode usar os dispositivos cadastrados ou fornecer uma lista manual.</p>

    <section>
      <h2>Usar dispositivos cadastrados</h2>
      <label>Tarifa (por kWh): <input id="tarifa1" type="number" step="0.01" value="0.8"></label>
      <button class="btn" id="calcDB">Calcular usando banco</button>
      <pre id="resDB"></pre>
    </section>

    <section>
      <h2>Lista manual</h2>
      <form id="manualForm">
        <div id="lista"></div>
        <button type="button" class="btn" id="add">Adicionar item</button>
        <label>Tarifa (por kWh): <input id="tarifa2" type="number" step="0.01" value="0.8"></label>
        <button class="btn" type="submit">Calcular manual</button>
      </form>
      <pre id="resManual"></pre>
    </section>

    <p><a href="/">Voltar</a></p>
  </main>
<script>
document.getElementById('calcDB').addEventListener('click', async () => {
  const tarifa = Number(document.getElementById('tarifa1').value);
  const res = await fetch('/api/calculate-house', { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ tarifa }) });
  const json = await res.json();
  document.getElementById('resDB').innerText = JSON.stringify(json, null, 2);
});

const lista = document.getElementById('lista');
function novoItem() {
  const id = Math.random().toString(36).slice(2,7);
  const div = document.createElement('div');
  div.innerHTML = `
    <input placeholder="Nome" data-key="nome">
    <input placeholder="Potência (W)" data-key="potencia" type="number" step="0.1">
    <input placeholder="Horas/dia" data-key="horasUso" type="number" step="0.1">
    <button type="button" class="remove">x</button>
  `;
  div.querySelector('.remove').addEventListener('click', () => div.remove());
  lista.appendChild(div);
}
document.getElementById('add').addEventListener('click', novoItem);
novoItem();

document.getElementById('manualForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const tarifa = Number(document.getElementById('tarifa2').value);
  const itens = Array.from(lista.children).map(div => {
    return {
      nome: div.querySelector('[data-key=nome]').value,
      potencia: Number(div.querySelector('[data-key=potencia]').value),
      horasUso: Number(div.querySelector('[data-key=horasUso]').value)
    };
  });
  const res = await fetch('/api/calculate-house', {
    method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ devices: itens, tarifa })
  });
  const json = await res.json();
  document.getElementById('resManual').innerText = JSON.stringify(json, null, 2);
});
</script>
</html>
